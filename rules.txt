# Project Context
You are building a B2B Rental Management MVP for high-value items (Fine Jewelry).
The goal is a "Single-man MVP": prioritize simplicity, stability, and maintainability.
**Critical Constraint:** Inventory availability must be strictly accurate. We use Postgres Exclusion Constraints, not just application logic.

# Tech Stack
- **Framework:** Next.js 16 (App Router).
- **Language:** TypeScript (Strict).
- **Core:** React 19.
- **Database & Auth:** Supabase (Postgres).
- **Styling:** Tailwind CSS v4 + Shadcn UI.
- **State/Forms:** React Hook Form + Zod.

# Coding Guidelines

## 1. Next.js App Router & Server Actions
- **Route Handlers:** Use `app/api/.../route.ts` for public webhooks or specific REST needs, but prefer **Server Actions** for form mutations.
- **Async Cookies:** When using cookies in Server Components/Actions, always treat them as async (await `cookies()`) to ensure compatibility with Next.js 15+.
- **Client/Server Boundary:** Keep logic on the server (`"use server"`). Only use `"use client"` for interactivity (forms, dialogs).

## 2. Supabase Integration (Strict)
- **Library:** Use `@supabase/ssr`. DO NOT use the deprecated `@supabase/auth-helpers-nextjs`.
- **Client Creation:**
  - **Server:** Use `createServerClient` with cookie handling.
  - **Browser:** Use `createBrowserClient`.
- **RLS & Security:**
  - RLS is the primary security layer. Application logic should not re-implement access control manually if RLS can handle it.
  - For performance, prefer `(select auth.uid())` or wrapper functions (e.g., `is_admin()`) in RLS policies to reduce overhead.

## 3. Database & Data Model
- **Enums Over Constraints:** We use custom Postgres ENUM types for status fields (e.g., `reservation_status`), NOT `TEXT` with `CHECK` constraints. 
- **Migration Policy:** When adding a new status:
  1. Use `ALTER TYPE type_name ADD VALUE IF NOT EXISTS 'new_value';`
  2. Note: `ALTER TYPE ... ADD VALUE` cannot be executed inside a transaction block in some Postgres versions.
- **Critical Types:**
  - `reservations.status`: is a custom ENUM `reservation_status`.

## 4. UI/UX
- **Responsive:** The UI must be responsive (functional on mobile), but optimized for Desktop usage.
- **Feedback:** Use `sonner` or `toast` for user feedback.
- **Loading:** Use `Suspense` boundaries and Skeleton loaders.

# "Single-man MVP" Mindset
- **No Over-engineering:** Do not suggest Microservices, complex state management (Redux), or Stripe integration.
- **Bank Transfer Only:** The flow is Invoice -> Bank Transfer -> Manual "Mark as Paid".
- **Focus:** If the code involves "Availability", triple-check the logic.

# Schema & Migration Conventions (CRITICAL)
- **Single Source of Truth:** All schema changes MUST go through `supabase/migrations/`. Never use `setup.sql` directly.
- **Type Safety:** Always regenerate `database.types.ts` after any schema change: `npx supabase gen types typescript --project-id <id> > src/lib/database.types.ts`
- **Availability Queries:** All reservation date queries from PUBLIC/ANON users MUST use `get_unavailable_date_ranges()` RPC (SECURITY DEFINER). Never query `reservations` table directly - RLS will block it.
- **Date Columns:** `start_date`/`end_date` are `timestamptz`. Cast to `::DATE` for UI display.